trigger: none

# schedule is in UTC
schedules:
- cron: '30 6 * * 1-5'
  displayName: daily_run
  branches:
    include: [main]
  always: true 

pool:
  vmImage: ubuntu-latest

variables:
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    serviceConnection: 'Pitwall-Prod'
    containerRegistry: 'crmlpltfrmprd'
    resourceGroup: 'rg-datapltfrm-prd'
    containerName: 'verhuiskans-algoritme-prd'
    containerResourceGroup: 'rg-mlcontainers-prd'
    kvName: 'kv-ml-pltfrm-prd'
    OTAP: 'P'
  ${{ else }}:
    serviceConnection: 'Pitwall-Dev'
    containerRegistry: 'crmlpltfrmdev'
    resourceGroup: 'rg-datapltfrm-dev'
    containerName: 'verhuiskans-algoritme-dev'
    containerResourceGroup: 'rg-mlcontainers-dev'
    kvName: 'kv-ml-pltfrm-dev'
    OTAP: 'OTA'
  tags: |
    $(Build.BuildId)
    latest

jobs:
  - job:
    steps:

    - checkout: self
    - template: keyvault-firewall.yaml
      parameters:
        serviceConnection: $(serviceConnection)
        kvName: $(kvName)
        resourceGroup: $(resourceGroup)

    - task: AzureCLI@2
      displayName: Delete container instance for scheduled start
      inputs:
        azureSubscription: $(serviceConnection)
        scriptType: "bash"
        scriptLocation: "inlineScript"
        inlineScript: |
          az container delete --name 'ci-$(containerName)' --resource-group $(containerResourceGroup) --yes

    - task: AzureCLI@2
      displayName: Create container instance for scheduled start
      inputs:
        azureSubscription: $(serviceConnection)
        scriptType: "bash"
        scriptLocation: "inlineScript"
        inlineScript: |

          az container create \
            --resource-group $(containerResourceGroup) \
            --name 'ci-$(containerName)' \
            --image $(containerRegistry).azurecr.io/$(containerName):latest \
            --assign-identity $(ID-UAMI-DATASCIENCE-CI-RESOURCE-ID) \
            --registry-username $(containerRegistry) \
            --registry-password $(CONTAINER-REGISTRY-PASSWORD) \
            --log-analytics-workspace '$(LOG-ANALYTICS-WORKSPACE-ID)' \
            --log-analytics-workspace-key '$(LOG-ANALYTICS-WORKSPACE-PRIMARY-KEY)' \
            --secure-environment-variables \
                AML_SUBSCRIPTION_ID='$(AML-SUBSCRIPTION-ID)' \
                APPLICATION_INSIGHTS_CONNECTION_STRING='$(APPLICATION-INSIGHTS-CONNECTION-STRING)' \
                AZURE_CLIENT_ID='$(ID-UAMI-DATASCIENCE-CI-CLIENT-ID)' \
                RESOURCE_GROUP='$(RESOURCE-GROUP)' \
                AML_WORKSPACE_NAME='$(AML-WORKSPACE-NAME)' \
                TEAMS_WEBHOOK_DATASCIENCE_ALGEMEEN='$(TEAMS-WEBHOOK-DATASCIENCE-ALGEMEEN)' \
                AIM_LOGGING_URL='$(AIM-LOGGING-URL)' \
            --restart-policy Never \
            --cpu 2 \
            --memory 16 \
            --os-type Linux \